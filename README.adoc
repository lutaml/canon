= Canon: Semantic comparison for serialization formats
:toc:
:toclevels: 2

== Purpose

Canon provides canonicalization, pretty-printing, and semantic comparison for
serialization formats (XML, HTML, JSON, YAML). It produces standardized forms
suitable for comparison, testing, digital signatures, and human-readable output.

Key features:

* **Format support**: XML, HTML, JSON, YAML
* **Canonicalization**: W3C XML C14N 1.1, sorted JSON/YAML keys
* **Semantic comparison**: Compare meaning, not formatting
* **Multiple interfaces**: Ruby API, CLI, RSpec matchers
* **Smart diff output**: By-line or by-object modes with syntax highlighting

== Installation

Add to your application's Gemfile:

[source,ruby]
----
gem 'canon'
----

Then execute:

[source,bash]
----
$ bundle install
----

Or install directly:

[source,bash]
----
$ gem install canon
----

== Quick start

=== Format documents

[source,ruby]
----
require 'canon'

# Canonical form (compact)
Canon.format('<root><b>2</b><a>1</a></root>', :xml)
# => Pretty-printed XML (default behavior)

# Compact canonical form
require 'canon/xml/c14n'
Canon::Xml::C14n.canonicalize('<root><b>2</b><a>1</a></root>', with_comments: false)
# => "<root><b>2</b><a>1</a></root>"

# Pretty-print (human-readable with custom indent)
require 'canon/pretty_printer/xml'
xml_input = '<root><b>2</b><a>1</a></root>'
Canon::PrettyPrinter::Xml.new(indent: 2).format(xml_input)
----

=== Compare documents

[source,ruby]
----
require 'canon/comparison'

xml1 = '<root><a>1</a><b>2</b></root>'
xml2 = '<root>  <b>2</b>  <a>1</a>  </root>'

Canon::Comparison.equivalent?(xml1, xml2)
# => true (semantically equivalent despite formatting differences)

# Use semantic tree diff for operation-level analysis
result = Canon::Comparison.equivalent?(xml1, xml2,
  verbose: true,
  diff_algorithm: :semantic
)
result.operations  # => [INSERT, DELETE, UPDATE, MOVE operations]
----

=== Use in tests

[source,ruby]
----
require 'canon/rspec_matchers'

RSpec.describe 'XML generation' do
  it 'generates correct XML' do
    expect(actual_xml).to be_xml_equivalent_to(expected_xml)
  end
end
----

=== Command-line interface

[source,bash]
----
# Format a file
$ canon format input.xml --mode pretty

# Compare files
$ canon diff file1.xml file2.xml --verbose

# Get help
$ canon help
----

== Documentation

=== Using Canon

* **link:docs/RUBY_API[Ruby API]** - Using Canon from Ruby code
* **link:docs/CLI[Command-line interface]** - CLI commands and options
* **link:docs/RSPEC[RSpec matchers]** - Testing with Canon

=== Understanding Canon

* **link:docs/MATCH_ARCHITECTURE[Match architecture]** - How comparison
  works
* **link:docs/FORMATS[Format support]** - XML, HTML, JSON, YAML details
* **link:docs/MODES[Diff modes]** - By-line vs by-object comparison

=== Features

* **link:docs/PREPROCESSING[Preprocessing]** - Document normalization
  options
* **link:docs/MATCH_OPTIONS[Match options]** - Match dimensions and
  profiles
* **link:docs/TREE_DIFF[Semantic tree diff]** - Operation-level tree
  comparison
* **link:docs/SEMANTIC_TREE_DIFF[Semantic tree diff algorithm]** - Comprehensive guide to semantic diff
* **link:docs/ENV_CONFIG[Environment configuration]** - Configure via ENV variables including size limits
* **link:docs/DIFF_FORMATTING[Diff formatting]** - Customizing diff output
* **link:docs/CHARACTER_VISUALIZATION[Character visualization]** -
  Whitespace and special characters
* **link:docs/INPUT_VALIDATION[Input validation]** - Error handling

=== Advanced topics

* **link:docs/VERBOSE[Verbose mode]** - Two-tier diff architecture
* **link:docs/SEMANTIC_DIFF_REPORT[Semantic diff report]** - Diff report
  format
* **link:docs/NORMATIVE_INFORMATIVE_DIFFS[Normative vs informative diffs]** - Diff
  classification
* **link:docs/DIFF_ARCHITECTURE[Diff architecture]** - Technical pipeline
  details

== Features

=== Canonicalization

**XML**: W3C Canonical XML Version 1.1 specification with namespace
declaration ordering, attribute ordering, character encoding normalization, and
proper handling of xml:base, xml:lang, xml:space, and xml:id attributes.

**HTML**: Consistent formatting for HTML 4/5 and XHTML with automatic detection
and appropriate formatting rules.

**JSON/YAML**: Alphabetically sorted keys at all levels with consistent
formatting.

=== Semantic comparison

Compare documents based on meaning, not formatting:

* Whitespace normalization options
* Attribute/key order handling
* Comment handling with display control
* Multiple match dimensions with behaviors
* Predefined match profiles (strict, rendered, spec_friendly, content_only)

See link:docs/MATCH_OPTIONS[Match options] for details.

==== Comment display control

Control which differences are displayed in diff output:

[source,ruby]
----
# Show all differences (default)
result = Canon::Comparison.equivalent?(xml1, xml2,
  verbose: true,
  match: { comments: :ignore },
  show_diffs: :all
)

# Show only normative differences (affect equivalence)
result = Canon::Comparison.equivalent?(xml1, xml2,
  verbose: true,
  match: { comments: :ignore },
  show_diffs: :normative
)

# Show only informative differences
result = Canon::Comparison.equivalent?(xml1, xml2,
  verbose: true,
  match: { comments: :ignore },
  show_diffs: :informative
)
----

**CLI usage:**
[source,bash]
----
# Show all differences
$ canon diff file1.xml file2.xml --show-diffs all

# Show only normative differences
$ canon diff file1.xml file2.xml --show-diffs normative

# Show only informative differences
$ canon diff file1.xml file2.xml --show-diffs informative
----

**RSpec usage:**
[source,ruby]
----
expect(actual).to be_xml_equivalent_to(expected)
  .show_diffs(:normative)
----

=== Algorithm choice

Canon provides two diff algorithms:

* **DOM diff** (default): Stable, position-based comparison for traditional line-by-line output
* **Semantic tree diff** (experimental): Advanced operation detection (INSERT, DELETE, UPDATE, MOVE, MERGE, SPLIT, UPGRADE, DOWNGRADE)

[source,ruby]
----
# Use DOM diff (default, stable)
result = Canon::Comparison.equivalent?(doc1, doc2,
  verbose: true,
  diff_algorithm: :dom
)

# Use semantic tree diff (experimental, more intelligent)
result = Canon::Comparison.equivalent?(doc1, doc2,
  verbose: true,
  diff_algorithm: :semantic
)
----

**When to use semantic tree diff:**

* Need to detect high-level operations (moves, merges, splits)
* Documents have significant rearrangement
* Want statistical analysis of changes
* Need operation-level transformation analysis

**When to use DOM diff:**

* Need stable, well-tested comparison
* Want traditional line-by-line output
* Documents are similar in structure
* Maximum performance for large files

See link:docs/SEMANTIC_TREE_DIFF[Semantic tree diff algorithm] for comprehensive guide.

=== Size limits for large files

Canon provides configurable size limits to prevent hangs on pathologically large files:

* **File size limit**: Default 5MB (configurable)
* **Node count limit**: Default 10,000 nodes (configurable)
* **Diff output limit**: Default 10,000 lines (configurable)

[source,bash]
----
# Configure via environment variables
export CANON_MAX_FILE_SIZE=10485760      # 10MB
export CANON_MAX_NODE_COUNT=50000        # 50,000 nodes
export CANON_MAX_DIFF_LINES=20000        # 20,000 lines

bundle exec rspec
----

[source,ruby]
----
# Or programmatically
Canon::Config.instance.xml.diff.max_file_size = 10_485_760
Canon::Config.instance.xml.diff.max_node_count = 50_000
Canon::Config.instance.xml.diff.max_diff_lines = 20_000
----

See link:docs/ENV_CONFIG#size-limits[ENV_CONFIG] for details on size limit configuration.

=== Smart diff output

**By-line mode**: Traditional line-by-line diff with:

* DOM-guided semantic matching for XML
* Syntax-aware token highlighting
* Context lines around changes
* Whitespace visualization

**By-object mode**: Tree-based semantic diff with:

* Visual tree structure using box-drawing characters
* Shows only what changed (additions, removals, modifications)
* Color-coded output

See link:docs/MODES[Diff modes] for details.

=== Enhanced diff features

* **Three-tier diff classification**: Formatting-only (`[` dark gray/`]` light gray), informative (`<` blue/`>` cyan), and normative (`-` red/`+` green) differences with directional colors
* **Directional color coding**: Removals and additions use different colors within each tier (red/green for normative, blue/cyan for informative, dark gray/light gray for formatting)
* **Namespace declaration tracking**: Separate dimension for tracking `xmlns` and `xmlns:*` attribute changes, reported independently from regular data attributes
* **Namespace rendering**: Explicit namespace display in XML diffs using `ns:[uri]` or `ns:[{blank}]` format
* **Informative diff visualization**: Visually distinct blue/cyan markers for differences that don't affect equivalence
* **Formatting diff detection**: Automatically detects and highlights purely cosmetic whitespace/line break differences
* **Whitespace visualization**: Make invisible characters visible with CJK-safe
  Unicode symbols
* **Non-ASCII detection**: Warnings for unexpected Unicode characters
* **Customizable**: Character maps, context lines, grouping options

See link:docs/DIFF_FORMATTING[Diff formatting] and
link:docs/CHARACTER_VISUALIZATION[Character visualization] for details.

=== Input validation

Comprehensive validation with clear error messages showing exact line and
column numbers for syntax errors in XML, HTML, JSON, and YAML.

See link:docs/INPUT_VALIDATION[Input validation] for details.

== Examples

=== Ruby API example

[source,ruby]
----
require 'canon/comparison'

# Compare with custom options
Canon::Comparison.equivalent?(doc1, doc2,
  match: {
    text_content: :normalize,
    structural_whitespace: :ignore,
    comments: :ignore
  },
  verbose: true
)
----

See link:docs/RUBY_API[Ruby API documentation].

=== CLI example

[source,bash]
----
# Compare with semantic diff
$ canon diff file1.xml file2.xml \
  --verbose \
  --text-content normalize \
  --structural-whitespace ignore
----

See link:docs/CLI[CLI documentation].

=== RSpec example

[source,ruby]
----
# Configure globally
Canon::Config.configure do |config|
  config.xml.match.profile = :spec_friendly
  config.xml.diff.use_color = true
end

# Use in tests
RSpec.describe 'XML generation' do
  it 'generates correct structure' do
    expect(actual_xml).to be_xml_equivalent_to(expected_xml)
  end
end
----

See link:docs/RSPEC[RSpec documentation].

== Architecture

Canon follows an orchestrator pattern with MECE (Mutually Exclusive,
Collectively Exhaustive) principles:

**Comparison module** (`Canon::Comparison`): Format detection, validation, and
delegation to format-specific comparators (XML, HTML, JSON, YAML).

**DiffFormatter module** (`Canon::DiffFormatter`): Diff mode detection and
delegation to mode-specific formatters (by-line, by-object).

**Three-phase comparison**:

. **Preprocessing**: Optional document normalization (c14n, normalize, format)
. **Semantic matching**: Configurable match dimensions with behaviors
. **Diff rendering**: Formatted output with visualization

See link:docs/MATCH_ARCHITECTURE[Match architecture] for details.

=== CompareProfile architecture

Canon uses the **CompareProfile** class to encapsulate policy decisions about how differences in various dimensions should be handled during comparison. This provides clean separation of concerns between policy decisions, comparison logic, and difference classification.

==== Separation of concerns

The comparison system is divided into four distinct components:

**CompareProfile**:: Policy decisions (what to track, what affects equivalence)
**XmlComparator/HtmlComparator**:: Comparison logic (detect differences)
**DiffNode**:: Data representation (represents a difference)
**DiffClassifier**:: Classification logic (normative vs informative vs formatting)

Each component has ONE responsibility with no overlapping concerns:

* CompareProfile does NOT classify differences
* XmlComparator does NOT make policy decisions
* DiffClassifier does NOT compare documents

==== Policy methods

CompareProfile provides four key policy methods:

`track_dimension?(dimension)`:: Should DiffNodes be created for this dimension? Returns `true` in verbose mode to track all differences for reporting.

`affects_equivalence?(dimension)`:: Should differences affect equivalence? Determines the return value of the comparison.
Returns `false` for dimensions with `:ignore` behavior.

`normative_dimension?(dimension)`:: Is this dimension normative (affects equivalence) or informative (display only)?
Used by DiffClassifier to set the normative flag on DiffNodes.

`supports_formatting_detection?(dimension)`:: Can FormattingDetector apply to this dimension?
Returns `true` only for text/content dimensions (`:text_content`, `:structural_whitespace`, `:comments`).

==== Usage example

When using `match: { comments: :ignore }`:

* `track_dimension?(:comments)` returns `true` (track in verbose mode)
* `affects_equivalence?(:comments)` returns `false` (doesn't affect equivalence)
* `normative_dimension?(:comments)` returns `false` (informative only)

This ensures that comment differences are tracked and displayed in verbose mode but don't make documents non-equivalent.

.Example: Comment differences with :ignore behavior
====
[source,ruby]
----
xml1 = '<root><!-- comment 1 --><data>value</data></root>'
xml2 = '<root><!-- comment 2 --><data>value</data></root>'

result = Canon::Comparison.equivalent?(xml1, xml2,
  verbose: true,
  match: { comments: :ignore }
)

result.differences           # => [#<DiffNode @dimension=:comments>]
result.differences[0].normative?  # => false (informative)
result.equivalent?           # => true (doesn't affect equivalence)
----

The comment difference is tracked and displayed, but the documents are still considered equivalent because comments are set to `:ignore`.
====

== Development

After checking out the repo, run `bin/setup` to install dependencies. Then run
`rake spec` to run the tests. You can also run `bin/console` for an interactive
prompt.

== Contributing

Bug reports and pull requests are welcome on GitHub at
https://github.com/lutaml/canon.

== Copyright and license

Copyright Ribose. https://opensource.org/licenses/BSD-2-Clause[BSD-2-Clause
License].
