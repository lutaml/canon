---
layout: default
title: Normative vs Informative Diffs
nav_order: 42
parent: Advanced Topics
---
= Canon Normative vs Informative Diffs Architecture
:toc:
:toclevels: 3

== Overview

Canon distinguishes between two types of differences when comparing documents:

* **Normative diffs**: Semantic differences that affect the match result based on your match options
* **Informative diffs**: Textual differences that don't affect the match (semantically equivalent per match options)

This allows you to focus on differences that matter while optionally viewing formatting-only changes.

== Architecture

----
╔═══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                              CANON DIFF ARCHITECTURE                                                                             ║
║                                         Normative vs Informative Differences                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ COMPARISON LAYER: Semantic Analysis                                                                                                              │
│                                                                                                                                                  │
│  Input: Two documents (HTML, XML, JSON, YAML)                                                                                                   │
│  Output: Semantic differences between document trees                                                                                            │
│                                                                                                                                                  │
│  ┌────────────────────┐    ┌────────────────────┐    ┌────────────────────┐                  ┌──────────────────────────────────────┐         │
│  │  Tree Comparator   │    │  Tree Comparator   │    │  Tree Comparator   │                  │      Match Options                   │         │
│  │  (HTML/XML)        │    │  (JSON)            │    │  (YAML)            │                  │──────────────────────────────────────│         │
│  └─────────┬──────────┘    └─────────┬──────────┘    └─────────┬──────────┘                  │ Define what matters:                 │         │
│            └───────────────────────────┴───────────────────────┘                             │  • text_content                      │         │
│                                        │                                                      │  • structural_whitespace             │         │
│                                        ▼                                                      │  • attribute_whitespace              │         │
│                         Creates DiffNodes (semantic differences)                             │  • comments                          │         │
│                                        │                                                      │  • key_order                         │         │
│                                        │                                                      │                                      │         │
│  ┌─────────────────────────────────────┴───────────────────────────────────┐                │ Each dimension has behavior:         │         │
│  │  DiffNode                                                                │                │  • :strict    → must match exactly   │         │
│  │  Represents one semantic difference                                     │                │  • :normalize → match after cleanup  │         │
│  │──────────────────────────────────────────────────────────────────────────│                │  • :ignore    → don't care           │         │
│  │  • References nodes in both trees                                       │◄───Classified──┤                                      │         │
│  │  • Has a dimension (what differs)                                       │    based on    │ Classification:                      │         │
│  │  • Has a reason code                                                    │                │  If dimension is :ignore             │         │
│  │  • Marked as normative or informative                                         │                │    → INFORMATIVE diff                   │         │
│  └──────────────────────────────────────────────────────────────────────────┘                │  If dimension is :strict or :normalize│        │
│                                                                                               │    → NORMATIVE diff                     │         │
│  Normative diff = Difference that affects the match result                                      └──────────────────────────────────────┘         │
│  Informative diff = Difference that doesn't affect the match (semantically equivalent)                                                            │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ RENDERING LAYER: Text Display                                                                                                                   │
│                                                                                                                                                  │
│  Input: DiffNodes from comparison, original text documents                                                                                      │
│  Output: Formatted diff with line numbers and markers                                                                                           │
│                                                                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐           │
│  │ STEP 1: Map Semantic Diffs to Text Lines                                                                                        │           │
│  │                                                                                                                                  │           │
│  │  DiffNodeMapper bridges semantic differences to text representation:                                                            │           │
│  │   • Uses line-by-line text diff (Diff::LCS)                                                                                     │           │
│  │   • Maps each changed line to its corresponding DiffNode                                                                        │           │
│  │   • Creates DiffLine objects that link text ↔ semantics                                                                        │           │
│  │                                                                                                                                  │           │
│  │  DiffLine                                                                                                                        │           │
│  │  ────────                                                                                                                        │           │
│  │  • Line numbers in both documents                                                                                               │           │
│  │  • Content of the line                                                                                                          │           │
│  │  • Reference to DiffNode (may be nil for purely textual changes)                                                                │           │
│  │  • Inherits normative/informative status from DiffNode                                                                                │           │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘           │
│                                              │                                                                                                  │
│                                              ▼                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐           │
│  │ STEP 2: Group Lines into Blocks                                                                                                 │           │
│  │                                                                                                                                  │           │
│  │  DiffBlock                                                                                                                       │           │
│  │  ──────────                                                                                                                      │           │
│  │  • Contiguous run of changed lines                                                                                              │           │
│  │  • Contains one or more DiffLines                                                                                                │           │
│  │  • Has reference to DiffNode if block maps to single semantic change                                                            │           │
│  │  • Normative if any contained line is normative                                                                                       │           │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘           │
│                                              │                                                                                                  │
│                                              ▼                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐           │
│  │ STEP 3: Filter Based on Rendering Options                                                                                       │           │
│  │                                                                                                                                  │           │
│  │  show_diffs option controls which blocks are displayed:                                                                         │           │
│  │   • :normative    → Show only blocks with normative differences                                                                       │           │
│  │   • :informative  → Show only blocks with informative differences                                                                     │           │
│  │   • :all       → Show all differences                                                                                           │           │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘           │
│                                              │                                                                                                  │
│                                              ▼                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐           │
│  │ STEP 4: Add Context and Group for Display                                                                                       │           │
│  │                                                                                                                                  │           │
│  │  DiffContext                                                                                                                     │           │
│  │  ───────────                                                                                                                     │           │
│  │  • One or more DiffBlocks grouped by proximity                                                                                  │           │
│  │  • Includes surrounding unchanged lines for context                                                                             │           │
│  │  • Controlled by context_lines and diff_grouping_lines options                                                                  │           │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘           │
│                                              │                                                                                                  │
│                                              ▼                                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐           │
│  │ STEP 5: Format for Display                                                                                                      │           │
│  │                                                                                                                                  │           │
│  │  Normative differences:                        Informative differences:                                                               │           │
│  │    18|  -  <div class="TOC" id="_">           18|  ~  <div class="TOC" id="_">                                                  │           │
│  │    18|  +  <div id="_" class="TOC">           18|  ~  <div id="_" class="TOC">                                                  │           │
│  │         ▲                                           ▲                                                                            │           │
│  │     Red/Green markers                           Cyan marker                                                                     │           │
│  │     (semantic difference)                       (textual difference only)                                                       │           │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
----

== Example: Attribute Order

Consider comparing these two HTML elements:

[source,html]
----
<!-- Document 1 -->
<div class="TOC" id="_">

<!-- Document 2 -->
<div id="_" class="TOC">
----

=== Comparison Layer

The comparator detects that attribute order differs and creates a `DiffNode`:

* `dimension`: `:attribute_whitespace`
* `reason`: `ATTRIBUTE_ORDER_DIFFERS`

=== Classification

The `DiffNode` is classified based on your match options:

* If `attribute_whitespace: :strict` → **NORMATIVE** (order matters to you)
** Display: `18| - <div class="TOC" id="_">` (red)
** Display: `18| + <div id="_" class="TOC">` (green)

* If `attribute_whitespace: :normalize` → **INFORMATIVE** (order doesn't matter)
** Display: `18| ~ <div class="TOC" id="_">` (cyan)
** Display: `18| ~ <div id="_" class="TOC">` (cyan)

=== Rendering Options

Control which diffs are displayed with `show_diffs`:

* `:normative` → Skip this block (it's informative when normalized)
* `:informative` → Show with `~` marker in cyan
* `:all` → Show all diffs

== Usage

=== RSpec Matchers

[source,ruby]
----
# Show only normative diffs (default)
expect(actual).to be_html4_equivalent_to(expected, show_diffs: :normative)

# Show only informative diffs
expect(actual).to be_html4_equivalent_to(expected, show_diffs: :informative)

# Show all diffs
expect(actual).to be_html4_equivalent_to(expected, show_diffs: :all)
----

=== CLI

[source,bash]
----
# Show only normative diffs (default)
canon diff file1.html file2.html

# Show informative diffs
canon diff file1.html file2.html --show-diffs=informative

# Show all diffs
canon diff file1.html file2.html --show-diffs=all
----

== Implementation Components

=== New Classes

* `Canon::Diff::DiffNode` - Represents a semantic difference
* `Canon::Diff::DiffLine` - Represents a changed text line
* `Canon::Diff::DiffNodeMapper` - Bridges semantic and textual differences
* `Canon::Diff::DiffClassifier` - Classifies diffs as normative/informative

=== Enhanced Classes

* `Canon::Diff::DiffBlock` - Add `diff_lines`, `diff_node`, `normative?`
* `Canon::Diff::DiffContext` - Add `has_normative_diffs?`, `has_informative_diffs?`
* `Canon::DiffFormatter` - Add `show_diffs` option
* Line formatters - Support `~` marker and cyan color for informative diffs

=== Comparators

Update `XmlComparator`, `JsonComparator`, `YamlComparator` to:

* Track dimension for each difference
* Create `DiffNode` objects instead of simple hashes
* Store differences with semantic context
